"use strict";(()=>{var e={};e.id=594,e.ids=[594],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},8295:(e,t,a)=>{a.r(t),a.d(t,{patchFetch:()=>A,routeModule:()=>R,serverHooks:()=>C,workAsyncStorage:()=>z,workUnitAsyncStorage:()=>j});var i={};a.r(i),a.d(i,{GET:()=>O,OPTIONS:()=>M,POST:()=>S});var r=a(96559),s=a(48088),l=a(37719),n=a(32190),d=a(66321),o=a(79748),u=a.n(o),p=a(33873),m=a.n(p),c=a(55511),g=a.n(c),f=a(47687),h=a(31075);let w="public/uploads",x="public/uploads/thumbnails",y="data/media-index.json",_=["image/jpeg","image/png","image/webp","image/gif"],v=["video/mp4","video/webm","video/ogg"],F=["audio/mp3","audio/wav","audio/ogg"],I=["application/pdf","text/plain","application/json"];class b{constructor(){this.mediaIndex=[],this.statsCache=null,this.initializeMediaManager()}async initializeMediaManager(){try{await u().mkdir(w,{recursive:!0}),await u().mkdir(x,{recursive:!0}),await this.loadMediaIndex(),await h.vF.info("media","MediaManager initialized successfully",{totalFiles:this.mediaIndex.length})}catch(e){throw await h.vF.error("media","Failed to initialize MediaManager",e),e}}async loadMediaIndex(){try{if(await f.OT.exists(y)){let e=await f.OT.readJSON(y);this.mediaIndex=e.data.files||[]}else this.mediaIndex=[],await this.saveMediaIndex()}catch(e){await h.vF.warn("media","Could not load media index, using empty list",{error:e.message}),this.mediaIndex=[]}}async saveMediaIndex(){await f.OT.writeJSON(y,{files:this.mediaIndex,updated_at:new Date().toISOString()},{createBackup:!0,ensureDirectory:!0})}getMediaType(e){return _.includes(e)?"image":v.includes(e)?"video":F.includes(e)?"audio":I.includes(e)?"document":"other"}validateFile(e,t,a,i={}){let r=i.maxSize||0xa00000;return t>r?{valid:!1,error:`File size ${(t/1024/1024).toFixed(2)}MB exceeds maximum ${(r/1024/1024).toFixed(2)}MB`}:i.allowedTypes&&!i.allowedTypes.includes(a)?{valid:!1,error:`File type ${a} not allowed. Allowed types: ${i.allowedTypes.join(", ")}`}:[..._,...v,...F,...I].includes(a)?{valid:!0}:{valid:!1,error:`File type ${a} not supported`}}generateUniqueFilename(e,t){let a=m().extname(e).toLowerCase(),i=m().basename(e,a).replace(/[^a-zA-Z0-9-_]/g,"_"),r=Date.now(),s=g().randomBytes(4).toString("hex"),l=t?`${t}_`:"";return`${l}${i}_${r}_${s}${a}`}async getImageMetadata(e){return{}}async generateThumbnail(e,t){try{let a=`thumb_${t}`,i=m().join(x,a);return await u().copyFile(e,i),`/uploads/thumbnails/${a}`}catch(e){return await h.vF.warn("media","Failed to generate thumbnail",{file:t,error:e.message}),null}}async uploadFile(e,t,a,i,r={}){try{let s=this.validateFile(t,e.length,a,r);if(!s.valid)throw Error(s.error);let l=this.generateUniqueFilename(t,r.prefix),n=m().join(w,l),d=`/uploads/${l}`;await u().writeFile(n,e);let o=this.getMediaType(a),p={id:`media_${g().randomBytes(8).toString("hex")}`,filename:l,original_name:t,path:n,url:d,type:o,mime_type:a,size:e.length,alt_text:r.alt_text||"",title:r.title||t,description:r.description||"",tags:r.tags||[],uploaded_by:i,uploaded_at:new Date().toISOString(),updated_at:new Date().toISOString(),metadata:{}};if("image"===o){let e=await this.getImageMetadata(n);if(p.width=e.width,p.height=e.height,!1!==r.generateThumbnail){let e=await this.generateThumbnail(n,l);e&&(p.thumbnail=e)}}return this.mediaIndex.push(p),await this.saveMediaIndex(),this.statsCache=null,await h.vF.info("media","File uploaded successfully",{fileId:p.id,filename:p.filename,size:p.size,type:p.type,uploadedBy:i}),p}catch(a){throw await h.vF.error("media","Failed to upload file",a,{originalName:t,size:e.length,uploadedBy:i}),a}}async searchFiles(e={}){let t=[...this.mediaIndex];if(e.type&&(t=t.filter(t=>t.type===e.type)),e.search){let a=e.search.toLowerCase();t=t.filter(e=>e.original_name.toLowerCase().includes(a)||e.title?.toLowerCase().includes(a)||e.description?.toLowerCase().includes(a)||e.tags.some(e=>e.toLowerCase().includes(a)))}if(e.tags&&e.tags.length>0&&(t=t.filter(t=>e.tags.some(e=>t.tags.includes(e)))),e.uploaded_by&&(t=t.filter(t=>t.uploaded_by===e.uploaded_by)),e.date_from){let a=new Date(e.date_from);t=t.filter(e=>new Date(e.uploaded_at)>=a)}if(e.date_to){let a=new Date(e.date_to);t=t.filter(e=>new Date(e.uploaded_at)<=a)}let a=e.sort||"date",i=e.order||"desc";t.sort((e,t)=>{let r,s;switch(a){case"name":r=e.original_name,s=t.original_name;break;case"size":r=e.size,s=t.size;break;case"type":r=e.type,s=t.type;break;default:r=new Date(e.uploaded_at).getTime(),s=new Date(t.uploaded_at).getTime()}if("string"==typeof r&&"string"==typeof s){let e=r.localeCompare(s);return"desc"===i?-e:e}return"desc"===i?s-r:r-s});let r=e.offset||0,s=e.limit||20;return{files:t.slice(r,r+s),total:t.length,pagination:{offset:r,limit:s,hasMore:r+s<t.length}}}getFileById(e){return this.mediaIndex.find(t=>t.id===e)||null}async updateFile(e,t,a){let i=this.mediaIndex.findIndex(t=>t.id===e);if(-1===i)throw Error("File not found");let r=this.mediaIndex[i],s={...r,...t,updated_at:new Date().toISOString()};return this.mediaIndex[i]=s,await this.saveMediaIndex(),await h.vF.info("media","File metadata updated",{fileId:e,filename:r.filename,updatedBy:a,updates:Object.keys(t)}),s}async deleteFile(e,t){let a=this.mediaIndex.findIndex(t=>t.id===e);if(-1===a)throw Error("File not found");let i=this.mediaIndex[a];try{if(await u().unlink(i.path),i.thumbnail){let e=m().join(process.cwd(),"public",i.thumbnail);try{await u().unlink(e)}catch{}}return this.mediaIndex.splice(a,1),await this.saveMediaIndex(),this.statsCache=null,await h.vF.info("media","File deleted successfully",{fileId:e,filename:i.filename,deletedBy:t}),!0}catch(a){throw await h.vF.error("media","Failed to delete file",a,{fileId:e,filename:i.filename,deletedBy:t}),a}}async validateExternalUrl(e){try{return new URL(e),{valid:!0,metadata:{type:"external"}}}catch(e){return{valid:!1,error:"Invalid URL format"}}}async getStats(){if(this.statsCache&&this.statsCache.expires>Date.now())return this.statsCache.stats;let e={total_files:this.mediaIndex.length,total_size:this.mediaIndex.reduce((e,t)=>e+t.size,0),files_by_type:{image:0,video:0,audio:0,document:0,other:0},average_file_size:0,storage_usage_mb:0,recent_uploads:0};for(let t of this.mediaIndex)e.files_by_type[t.type]++;e.total_files>0&&(e.average_file_size=e.total_size/e.total_files),e.storage_usage_mb=e.total_size/1048576;let t=new Date(Date.now()-864e5);return e.recent_uploads=this.mediaIndex.filter(e=>new Date(e.uploaded_at)>t).length,this.statsCache={stats:e,expires:Date.now()+3e5},e}getAllTags(){let e=new Set;for(let t of this.mediaIndex)t.tags.forEach(t=>e.add(t));return Array.from(e).sort()}async cleanupOrphanedFiles(){let e=0,t=0;try{let a=await u().readdir(w),i=this.mediaIndex.map(e=>e.filename);for(let r of a.filter(e=>!i.includes(e)))try{await u().unlink(m().join(w,r)),e++}catch(e){t++,await h.vF.warn("media",`Failed to delete orphaned file: ${r}`,{error:e.message})}e>0&&await h.vF.info("media","Cleanup completed",{cleaned:e,errors:t})}catch(e){await h.vF.error("media","Failed to cleanup orphaned files",e),t++}return{cleaned:e,errors:t}}}let T=new b,O=(0,d.ru)(async(e,t)=>{try{let{searchParams:t}=new URL(e.url),a={type:t.get("type"),search:t.get("search"),tags:t.get("tags")?.split(",").filter(Boolean),uploaded_by:t.get("uploaded_by"),date_from:t.get("date_from"),date_to:t.get("date_to"),limit:t.get("limit")?parseInt(t.get("limit")):20,offset:t.get("offset")?parseInt(t.get("offset")):0,sort:t.get("sort")||"date",order:t.get("order")||"desc"},i=await T.searchFiles(a),r=await T.getStats(),s=T.getAllTags();return n.NextResponse.json({success:!0,data:{files:i.files,pagination:i.pagination,total:i.total,stats:r,available_tags:s,query:a}})}catch(e){return await h.vF.error("media-api","Failed to list media files",e,{userId:t.user.id}),n.NextResponse.json({success:!1,error:"INTERNAL_ERROR",message:"Failed to retrieve media files."},{status:500})}},(0,d.PS)("media","read")()),S=(0,d.ru)(async(e,t)=>{try{let a=await e.formData(),i=a.get("file");if(!i)return n.NextResponse.json({success:!1,error:"NO_FILE",message:"No file provided."},{status:400});let r={alt_text:a.get("alt_text")||"",title:a.get("title")||i.name,description:a.get("description")||"",tags:(a.get("tags")||"").split(",").filter(Boolean),prefix:a.get("prefix")||void 0,generateThumbnail:"false"!==a.get("generate_thumbnail"),optimizeImage:"false"!==a.get("optimize_image")},s=await i.arrayBuffer(),l=Buffer.from(s),d=await T.uploadFile(l,i.name,i.type,t.user.id,r);return n.NextResponse.json({success:!0,message:"File uploaded successfully.",data:{file:d}},{status:201})}catch(e){if(await h.vF.error("media-api","Failed to upload file",e,{userId:t.user.id}),e.message.includes("File size")||e.message.includes("File type"))return n.NextResponse.json({success:!1,error:"VALIDATION_ERROR",message:e.message},{status:400});return n.NextResponse.json({success:!1,error:"INTERNAL_ERROR",message:"Failed to upload file."},{status:500})}},(0,d.PS)("media","write")());async function M(){return new n.NextResponse(null,{status:200,headers:{Allow:"GET, POST, OPTIONS","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let R=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/admin/media/route",pathname:"/api/admin/media",filename:"route",bundlePath:"app/api/admin/media/route"},resolvedPagePath:"/root/proyectos/freelos/metrica/src/app/api/admin/media/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:z,workUnitAsyncStorage:j,serverHooks:C}=R;function A(){return(0,l.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:j})}},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{e.exports=require("buffer")},79748:e=>{e.exports=require("fs/promises")},94735:e=>{e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[4447,580,3205,1220,6321],()=>a(8295));module.exports=i})();