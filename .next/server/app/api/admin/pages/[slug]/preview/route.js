"use strict";(()=>{var e={};e.id=9963,e.ids=[9963],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{e.exports=require("path")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{e.exports=require("crypto")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66153:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>h,serverHooks:()=>f,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{OPTIONS:()=>c,POST:()=>d});var a=r(96559),i=r(48088),o=r(37719),n=r(32190),l=r(66321),p=r(73801),u=r(31075);let d=(0,l.ru)(async(e,t,{params:r})=>{try{let{slug:t}=r,{content:s}=await e.json();if(!s)return n.NextResponse.json({success:!1,error:"INVALID_INPUT",message:"Page content is required for preview."},{status:400});let a=await p.Nc.validate(s,"static-page",{migrationMode:!0,autoFix:!0,generateSuggestions:!0}),i={slug:t,title:s.hero?.title||s.metadata?.title||t,description:s.hero?.subtitle||s.metadata?.description||"",sections_count:Array.isArray(s.sections)?s.sections.length:0,hero:s.hero||null,sections:s.sections||[],metadata:s.metadata||{}},o={total_sections:i.sections_count,has_hero:!!i.hero,has_metadata:Object.keys(i.metadata).length>0,validation:{valid:a.valid,errors_count:a.errors.length,warnings_count:a.warnings.length,fixes_applied:a.fixes.length,compatibility_level:a.stats.compatibilityLevel}};return n.NextResponse.json({success:!0,data:{preview:i,stats:o,validation:{valid:a.valid,errors:a.errors.slice(0,5),warnings:a.warnings.slice(0,5),suggestions:a.suggestions.slice(0,10),fixes_applied:a.fixes.map(e=>({path:e.path,type:e.type,description:e.description}))}}})}catch(e){return await u.vF.error("pages-api",`Failed to generate preview: ${r.slug}`,e,{userId:t.user.id}),n.NextResponse.json({success:!1,error:"INTERNAL_ERROR",message:"Failed to generate page preview."},{status:500})}},(0,l.PS)("pages","read")());async function c(){return new n.NextResponse(null,{status:200,headers:{Allow:"POST, OPTIONS","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let h=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/admin/pages/[slug]/preview/route",pathname:"/api/admin/pages/[slug]/preview",filename:"route",bundlePath:"app/api/admin/pages/[slug]/preview/route"},resolvedPagePath:"/root/proyectos/freelos/metrica/src/app/api/admin/pages/[slug]/preview/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:g,serverHooks:f}=h;function y(){return(0,o.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:g})}},73801:(e,t,r)=>{r.d(t,{Nc:()=>h,sx:()=>c});var s=r(94371),a=r.n(s),i=r(14659),o=r.n(i),n=r(79748),l=r.n(n),p=r(33873),u=r.n(p);class d extends Error{constructor(e){super(`Schema '${e}' not found`),this.name="SchemaNotFoundError"}}class c{constructor(){this.schemas=new Map,this.schemaConfigs=new Map,this.defaultOptions={strict:!1,autoFix:!0,allowExtraProperties:!0,skipMissingRequired:!1,generateSuggestions:!0,migrationMode:!0},this.ajv=new(a())({allErrors:!0,verbose:!0,strict:!1,removeAdditional:!1,useDefaults:!0,coerceTypes:!0}),o()(this.ajv),this.setupCustomKeywords()}setupCustomKeywords(){this.ajv.addKeyword({keyword:"flexibleRequired",type:"object",schemaType:"array",compile:e=>function(t,r){let s=[];for(let r of e)r in t||s.push(r);return!!(s.length>0&&r?.parentData?.migrationMode)||0===s.length}}),this.ajv.addKeyword({keyword:"autoNormalize",type:["string","object","array"],schemaType:"object",compile:e=>function(e){return!0}})}async loadSchema(e,t){try{let r=u().resolve(t),s=JSON.parse(await l().readFile(r,"utf-8"));this.ajv.addSchema(s,e),this.schemas.set(e,s);let a={name:e,path:t,strict:!1,required:s.required||[],optional:[],patterns:{}};this.schemaConfigs.set(e,a)}catch(r){throw Error(`Failed to load schema '${e}' from '${t}': ${r.message}`)}}async loadAllSchemas(){let e=u().join(process.cwd(),"data/schemas");for(let t of[{name:"static-page",path:"pages/static-page.schema.json"},{name:"portfolio",path:"dynamic-content/portfolio.schema.json"},{name:"careers",path:"dynamic-content/careers.schema.json"},{name:"newsletter",path:"dynamic-content/newsletter.schema.json"}]){let r=u().join(e,t.path);await this.loadSchema(t.name,r)}}getSchemaForFile(e){let t=e.replace(/^.*\/public\/json\//,"");return t.startsWith("pages/")?"static-page":t.includes("portfolio")?"portfolio":t.includes("careers")?"careers":t.includes("newsletter")?"newsletter":null}async validate(e,t,r={}){let s={...this.defaultOptions,...r},a=JSON.parse(JSON.stringify(e)),i=JSON.parse(JSON.stringify(e)),o={valid:!1,data:i,originalData:a,errors:[],warnings:[],suggestions:[],fixes:[],schema:t,stats:{errorsCount:0,warningsCount:0,fixesApplied:0,compatibilityLevel:"low"}},n=this.ajv.getSchema(t);if(!n)throw new d(t);if(s.autoFix){let e=await this.applyAutoFixes(i,t);o.fixes.push(...e),o.stats.fixesApplied=e.length}let l=n(i);if(o.valid=l,o.data=i,!l&&n.errors){if(o.errors=n.errors,o.stats.errorsCount=n.errors.length,!s.strict){let{errors:e,warnings:t}=this.categorizeErrors(n.errors,s);o.errors=e,o.warnings=t,o.stats.warningsCount=t.length,0===e.length&&(o.valid=!0)}s.generateSuggestions&&(o.suggestions=this.generateSuggestions(n.errors,i))}return o.stats.compatibilityLevel=this.calculateCompatibilityLevel(o),o}async applyAutoFixes(e,t){let r=[],s=this.schemas.get(t);if(!s)return r;if(s.required&&Array.isArray(s.required)){for(let t of s.required)if(!(t in e)&&s.properties&&s.properties[t]){let a=s.properties[t],i=this.getDefaultValue(a);void 0!==i&&(e[t]=i,r.push({path:t,type:"added",newValue:i,description:`Added missing required field '${t}' with default value`}))}}return r.push(...this.normalizeStatsFields(e)),r.push(...this.normalizeIdFields(e)),r.push(...this.normalizeUrlFields(e)),r}normalizeStatsFields(e,t=""){let r=[];if(e&&"object"==typeof e)for(let[s,a]of Object.entries(e)){let i=t?`${t}.${s}`:s;if("stats"===s&&a&&"object"==typeof a&&!Array.isArray(a)){let t=Object.entries(a).map(([e,t])=>({key:e,value:t,label:this.humanizeKey(e)}));e[s]=t,r.push({path:i,type:"converted",oldValue:a,newValue:t,description:"Converted stats object to array format"})}else a&&"object"==typeof a&&r.push(...this.normalizeStatsFields(a,i))}return r}normalizeIdFields(e,t=""){let r=[];if(e&&"object"==typeof e)for(let[s,a]of Object.entries(e)){let i=t?`${t}.${s}`:s;if("id"===s&&"string"!=typeof a&&null!=a){let t=String(a);e[s]=t,r.push({path:i,type:"converted",oldValue:a,newValue:t,description:`Converted ID from ${typeof a} to string`})}else a&&"object"==typeof a&&r.push(...this.normalizeIdFields(a,i))}return r}normalizeUrlFields(e,t=""){let r=[];if(e&&"object"==typeof e)for(let[s,a]of Object.entries(e)){let e=t?`${t}.${s}`:s;("url"===s||s.includes("url")||s.includes("link"))&&"string"==typeof a&&a.startsWith("/")||a&&"object"==typeof a&&r.push(...this.normalizeUrlFields(a,e))}return r}getDefaultValue(e){if(void 0!==e.default)return e.default;switch(e.type){case"string":return"";case"number":case"integer":return 0;case"boolean":return!1;case"array":return[];case"object":return{};default:return}}humanizeKey(e){return e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase()).trim()}categorizeErrors(e,t){let r=[],s=[];for(let a of e){if(t.migrationMode){if("required"===a.keyword&&t.skipMissingRequired){s.push(`Missing required field: ${a.params?.missingProperty||a.instancePath}`);continue}if("additionalProperties"===a.keyword&&t.allowExtraProperties){s.push(`Additional property: ${a.instancePath}/${a.params?.additionalProperty}`);continue}if("type"===a.keyword&&this.isMinorTypeError(a)){s.push(`Type mismatch: ${a.instancePath} (${a.message})`);continue}}r.push(a)}return{errors:r,warnings:s}}isMinorTypeError(e){return["number vs string","object vs array","string vs null"].some(t=>e.message?.toLowerCase().includes(t.toLowerCase()))}generateSuggestions(e,t){let r=[],s=new Set(e.map(e=>e.keyword));for(let t of e)switch(t.keyword){case"required":r.push(`Add missing required field: ${t.params?.missingProperty}`);break;case"type":r.push(`Convert ${t.instancePath} from ${typeof t.data} to ${t.schema}`);break;case"format":"uri"===t.schema?r.push(`Ensure ${t.instancePath} is a valid URL`):"email"===t.schema&&r.push(`Ensure ${t.instancePath} is a valid email`);break;case"pattern":r.push(`${t.instancePath} must match pattern: ${t.schema}`)}return s.has("type")&&r.push("Consider running auto-fix to normalize data types"),s.has("required")&&r.push("Use migration mode to add missing fields gradually"),[...new Set(r)]}calculateCompatibilityLevel(e){let{errorsCount:t,warningsCount:r,fixesApplied:s}=e.stats;return e.valid&&0===t+r?"full":e.valid&&0===t?"high":t<=3&&s>0?"medium":"low"}async validateFile(e,t={}){let r=this.getSchemaForFile(e);if(!r)throw Error(`No schema available for file: ${e}`);let s=JSON.parse(await l().readFile(e,"utf-8"));return this.validate(s,r,t)}getValidationStats(){return{schemasLoaded:this.schemas.size,availableSchemas:Array.from(this.schemas.keys()),defaultOptions:this.defaultOptions}}}let h=new c},79428:e=>{e.exports=require("buffer")},79748:e=>{e.exports=require("fs/promises")},94735:e=>{e.exports=require("events")}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,580,3205,4659,1220,6321],()=>r(66153));module.exports=s})();