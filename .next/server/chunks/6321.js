"use strict";exports.id=6321,exports.ids=[6321],exports.modules={20108:(e,s,t)=>{t.d(s,{E:()=>o});var i=t(47687),r=t(31075);class a{constructor(){this.permissionMatrix=null,this.permissionCache=new Map,this.accessLogs=[],this.matrixFile="data/permissions.json",this.accessLogsFile="data/access-logs.json",this.cacheTimeout=3e5,this.initializePermissions()}async initializePermissions(){try{await this.loadPermissionMatrix(),await this.loadAccessLogs(),this.startCacheCleanup(),await r.vF.info("permissions","PermissionsManager initialized successfully",{rolesCount:this.permissionMatrix?Object.keys(this.permissionMatrix.roles).length:0,resourcesCount:this.permissionMatrix?Object.keys(this.permissionMatrix.resources).length:0})}catch(e){throw await r.vF.error("permissions","Failed to initialize PermissionsManager",e),e}}async loadPermissionMatrix(){try{if(await i.OT.exists(this.matrixFile)){let e=await i.OT.readJSON(this.matrixFile);this.permissionMatrix=e.data}else await this.createDefaultPermissionMatrix()}catch(e){await r.vF.warn("permissions","Could not load permission matrix, using defaults",{error:e.message}),await this.createDefaultPermissionMatrix()}}async createDefaultPermissionMatrix(){let e={roles:{admin:{name:"admin",description:"Administrador con acceso completo",permissions:[{resource:"pages",action:"admin",description:"Control total de p\xe1ginas"},{resource:"portfolio",action:"admin",description:"Control total del portfolio"},{resource:"careers",action:"admin",description:"Control total de empleos"},{resource:"newsletter",action:"admin",description:"Control total del newsletter"},{resource:"users",action:"admin",description:"Gesti\xf3n de usuarios"},{resource:"settings",action:"admin",description:"Configuraci\xf3n del sistema"},{resource:"media",action:"admin",description:"Gesti\xf3n de medios"},{resource:"backups",action:"admin",description:"Gesti\xf3n de backups"}]},editor:{name:"editor",description:"Editor de contenido",permissions:[{resource:"pages",action:"write",description:"Editar p\xe1ginas"},{resource:"portfolio",action:"write",description:"Editar portfolio"},{resource:"careers",action:"write",description:"Editar empleos"},{resource:"newsletter",action:"write",description:"Editar newsletter"},{resource:"media",action:"write",description:"Subir y gestionar medios"},{resource:"users",action:"read",description:"Ver informaci\xf3n de usuarios"},{resource:"settings",action:"read",description:"Ver configuraci\xf3n"}],restrictions:{forbidden_fields:["created_at","created_by","system_metadata"],conditions:[{type:"status",field:"status",operator:"not_equals",value:"system"}]}},viewer:{name:"viewer",description:"Solo lectura",permissions:[{resource:"pages",action:"read",description:"Ver p\xe1ginas"},{resource:"portfolio",action:"read",description:"Ver portfolio"},{resource:"careers",action:"read",description:"Ver empleos"},{resource:"newsletter",action:"read",description:"Ver newsletter"},{resource:"media",action:"read",description:"Ver medios"}],restrictions:{max_items:100,forbidden_fields:["email","internal_notes","system_metadata"]}}},resources:{pages:{name:"P\xe1ginas",description:"P\xe1ginas est\xe1ticas del sitio",actions:{read:"Ver contenido de p\xe1ginas",write:"Editar p\xe1ginas existentes",delete:"Eliminar p\xe1ginas (no aplicable)",admin:"Control total de p\xe1ginas"}},portfolio:{name:"Portfolio",description:"Proyectos y categor\xedas del portfolio",actions:{read:"Ver proyectos y categor\xedas",write:"Crear y editar proyectos",delete:"Eliminar proyectos y categor\xedas",admin:"Control total del portfolio"}},careers:{name:"Empleos",description:"Ofertas de trabajo y departamentos",actions:{read:"Ver ofertas de trabajo",write:"Crear y editar ofertas",delete:"Eliminar ofertas",admin:"Control total de empleos"}},newsletter:{name:"Newsletter",description:"Art\xedculos, autores y categor\xedas del blog",actions:{read:"Ver art\xedculos y contenido",write:"Crear y editar art\xedculos",delete:"Eliminar art\xedculos",admin:"Control total del newsletter"}},users:{name:"Usuarios",description:"Gesti\xf3n de usuarios y roles",actions:{read:"Ver informaci\xf3n de usuarios",write:"Editar usuarios y asignar roles",delete:"Eliminar usuarios",admin:"Control total de usuarios"}},settings:{name:"Configuraci\xf3n",description:"Configuraci\xf3n del sistema",actions:{read:"Ver configuraci\xf3n",write:"Modificar configuraci\xf3n",delete:"Resetear configuraci\xf3n",admin:"Control total de configuraci\xf3n"}},media:{name:"Medios",description:"Archivos multimedia",actions:{read:"Ver archivos",write:"Subir y editar archivos",delete:"Eliminar archivos",admin:"Control total de medios"}},backups:{name:"Backups",description:"Copias de seguridad",actions:{read:"Ver backups",write:"Crear backups",delete:"Eliminar backups",admin:"Control total de backups"}}},version:"1.0.0",updated_at:new Date().toISOString()};this.permissionMatrix=e,await this.savePermissionMatrix(),await r.vF.info("permissions","Created default permission matrix",{rolesCount:Object.keys(e.roles).length,resourcesCount:Object.keys(e.resources).length})}async savePermissionMatrix(){this.permissionMatrix&&(this.permissionMatrix.updated_at=new Date().toISOString(),await i.OT.writeJSON(this.matrixFile,this.permissionMatrix,{createBackup:!0,ensureDirectory:!0}))}async loadAccessLogs(){try{if(await i.OT.exists(this.accessLogsFile)){let e=await i.OT.readJSON(this.accessLogsFile);this.accessLogs=e.data.logs||[];let s=new Date(Date.now()-2592e6);this.accessLogs=this.accessLogs.filter(e=>new Date(e.timestamp)>s)}}catch(e){await r.vF.warn("permissions","Could not load access logs",{error:e.message}),this.accessLogs=[]}}async saveAccessLogs(){await i.OT.writeJSON(this.accessLogsFile,{logs:this.accessLogs},{ensureDirectory:!0})}startCacheCleanup(){setInterval(()=>{let e=Date.now();for(let[s,t]of this.permissionCache.entries())t.expires<e&&this.permissionCache.delete(s)},6e4)}getCacheKey(e){return`${e.user.id}:${e.resource}:${e.action}:${e.resourceId||"global"}`}async checkPermission(e){try{let s=this.getCacheKey(e),t=this.permissionCache.get(s);if(t&&t.expires>Date.now())return t.result;let i=await this.evaluatePermission(e);return this.permissionCache.set(s,{result:i,expires:Date.now()+this.cacheTimeout}),await this.logAccess(e,i),i}catch(s){return await r.vF.error("permissions","Failed to check permission",s,{userId:e.user.id,resource:e.resource,action:e.action}),{allowed:!1,reason:"Permission check failed"}}}async evaluatePermission(e){if(!this.permissionMatrix)return{allowed:!1,reason:"Permission matrix not loaded"};let{user:s,resource:t,action:i}=e;if("active"!==s.status)return{allowed:!1,reason:"User account is not active"};let r=this.permissionMatrix.roles[s.role];if(!r)return{allowed:!1,reason:"User role not found"};let a=this.checkDirectPermission(r,t,i);if(a.allowed)return a;if(r.inherits)for(let e of r.inherits){let s=this.permissionMatrix.roles[e];if(s){let r=this.checkDirectPermission(s,t,i);if(r.allowed)return{...r,inherited_from:e}}}return{allowed:!1,reason:"Permission not granted"}}checkDirectPermission(e,s,t){let i=e.permissions.find(e=>e.resource===s&&(e.action===t||"admin"===e.action));if(!i)return{allowed:!1,reason:"Permission rule not found"};if("admin"===i.action)return{allowed:!0,reason:"Admin permission granted"};let r=["read","write","delete","admin"],a=r.indexOf(t);return r.indexOf(i.action)>=a?{allowed:!0,reason:`Permission granted: ${i.action}`,conditions:i.conditions}:{allowed:!1,reason:`Insufficient permission level: required ${t}, granted ${i.action}`}}async checkConditions(e,s){for(let t of s){let s=await this.evaluateCondition(e,t);if(!s.allowed)return s}return{allowed:!0,reason:"All conditions satisfied"}}async evaluateCondition(e,s){let{user:t,targetData:i}=e;switch(s.type){case"owner":if(!i)return{allowed:!1,reason:"Cannot verify ownership: no target data"};let r=s.field||"created_by",a=i[r]===t.id||i[r]===t.email;return{allowed:a,reason:a?"User is owner":"User is not owner"};case"role":let o=s.value===t.role;return{allowed:o,reason:o?"Role matches":`Role mismatch: required ${s.value}, user has ${t.role}`};case"status":if(!i||!s.field)return{allowed:!1,reason:"Cannot verify status: missing data or field"};let n=i[s.field],c=s.operator||"equals",l=s.value,d=!1;switch(c){case"equals":d=n===l;break;case"not_equals":d=n!==l;break;case"in":d=Array.isArray(l)&&l.includes(n);break;case"not_in":d=Array.isArray(l)&&!l.includes(n)}return{allowed:d,reason:d?"Status condition satisfied":`Status condition failed: ${n} ${c} ${l}`};case"custom":return{allowed:!0,reason:"Custom condition not implemented"};default:return{allowed:!1,reason:`Unknown condition type: ${s.type}`}}}async checkPermissionWithData(e,s,t,i,r){let a={user:e,resource:s,action:t,targetData:i,resourceId:r},o=await this.checkPermission(a);return o.allowed&&o.conditions&&o.conditions.length>0?this.checkConditions(a,o.conditions):o}async logAccess(e,s){let t={timestamp:new Date().toISOString(),user_id:e.user.id,user_email:e.user.email,resource:e.resource,action:e.action,resource_id:e.resourceId,allowed:s.allowed,reason:s.reason,ip_address:e.extraContext?.ip_address,user_agent:e.extraContext?.user_agent};this.accessLogs.push(t),this.accessLogs.length%100==0&&await this.saveAccessLogs(),s.allowed||await r.vF.warn("permissions","Access denied",{userId:e.user.id,resource:e.resource,action:e.action,reason:s.reason})}getUserPermissions(e){if(!this.permissionMatrix)return[];let s=this.permissionMatrix.roles[e.role];if(!s)return[];let t=[...s.permissions];if(s.inherits)for(let e of s.inherits){let s=this.permissionMatrix.roles[e];s&&t.push(...s.permissions)}return t}getAvailableResources(){return this.permissionMatrix?.resources||{}}getRoleDefinitions(){return this.permissionMatrix?.roles||{}}getRecentAccessLogs(e=100){return this.accessLogs.sort((e,s)=>new Date(s.timestamp).getTime()-new Date(e.timestamp).getTime()).slice(0,e)}clearPermissionCache(){this.permissionCache.clear(),r.vF.info("permissions","Permission cache cleared")}async reloadPermissions(){this.clearPermissionCache(),await this.loadPermissionMatrix(),await r.vF.info("permissions","Permission matrix reloaded")}}let o=new a},66321:(e,s,t)=>{t.d(s,{PS:()=>u,W0:()=>m,ru:()=>d});var i=t(32190),r=t(92e3),a=t(20108),o=t(31075);let n={requireAuth:!0,skipAuthForPaths:["/api/admin/auth/login","/api/admin/auth/verify"]};class c{constructor(e={}){this.requestCounts=new Map,this.config={...n,...e},this.startRateLimitCleanup()}startRateLimitCleanup(){setInterval(()=>{let e=Date.now();for(let[s,t]of this.requestCounts.entries())t.resetTime<e&&this.requestCounts.delete(s)},6e4)}extractToken(e){let s=e.headers.get("authorization");if(s&&s.startsWith("Bearer "))return s.substring(7);let t=e.cookies.get("auth-token")?.value;if(t)return t;let i=e.headers.get("x-auth-token");return i||null}getClientInfo(e){let s=e.headers.get("x-forwarded-for");return{ip:s?s.split(",")[0].trim():e.headers.get("x-real-ip")||e.headers.get("remote-addr")||"127.0.0.1",userAgent:e.headers.get("user-agent")||"Unknown"}}checkRateLimit(e,s){if(!s)return!0;let t=Date.now();s.windowMs;let i=this.requestCounts.get(e);return!i||i.resetTime<t?(i={count:1,resetTime:t+s.windowMs},this.requestCounts.set(e,i),!0):!(i.count>=s.max)&&(i.count++,!0)}createErrorResponse(e){let s=i.NextResponse.json({success:!1,error:e.error,message:e.message,code:e.code,timestamp:new Date().toISOString(),...e.details&&{details:e.details}},{status:e.status});return s.headers.set("X-Content-Type-Options","nosniff"),s.headers.set("X-Frame-Options","DENY"),s.headers.set("X-XSS-Protection","1; mode=block"),s}async authenticate(e){let{ip:s,userAgent:t}=this.getClientInfo(e),i=e.nextUrl.pathname;try{if(this.config.skipAuthForPaths?.some(e=>i.startsWith(e)))return{context:{user:null,session:null,permissions:[],isAuthenticated:!1}};if(this.config.rateLimiting&&!this.checkRateLimit(s,this.config.rateLimiting))return await o.vF.warn("auth-middleware","Rate limit exceeded",{ip:s,pathname:i}),{response:this.createErrorResponse({error:"RATE_LIMITED",message:"Too many requests. Please try again later.",status:429})};let t=this.extractToken(e);if(!t&&this.config.requireAuth)return{response:this.createErrorResponse({error:"UNAUTHORIZED",message:"Authentication token required.",status:401})};if(!t)return{context:{user:null,session:null,permissions:[],isAuthenticated:!1}};if("mock-token"===t){let e={id:"1",email:"admin@metrica.pe",name:"Admin Usuario",role:"admin",status:"active",created_at:new Date().toISOString(),login_attempts:0,metadata:{avatar:"",preferences:{}}},s={userId:e.id,sessionId:"mock-session",created_at:new Date().toISOString(),expires_at:new Date(Date.now()+864e5).toISOString()};return console.log("[AUTH] Mock token authentication successful for:",e.email),{context:{user:e,session:s,permissions:[{resource:"*",action:"*"}],isAuthenticated:!0}}}let n=r.s.verifyJWT(t);if(!n.valid)return await o.vF.warn("auth-middleware","Invalid JWT token",{ip:s,pathname:i,error:n.error}),{response:this.createErrorResponse({error:"INVALID_TOKEN",message:"Invalid or expired authentication token.",status:401,details:n.error})};let c=n.payload.sessionId,l=r.s.getSession(c);if(!l)return{response:this.createErrorResponse({error:"SESSION_EXPIRED",message:"Session has expired. Please log in again.",status:401})};let d=r.s.getUserBySession(c);if(!d)return{response:this.createErrorResponse({error:"USER_NOT_FOUND",message:"User account not found.",status:401})};if("active"!==d.status)return{response:this.createErrorResponse({error:"USER_INACTIVE",message:"User account is not active.",status:403})};let u=a.E.getUserPermissions(d);return await o.vF.info("auth-middleware","Authentication successful",{userId:d.id,email:d.email,sessionId:c,ip:s,pathname:i}),{context:{user:d,session:l,permissions:u,isAuthenticated:!0}}}catch(e){return await o.vF.error("auth-middleware","Authentication middleware error",e,{ip:s,pathname:i}),{response:this.createErrorResponse({error:"INTERNAL_ERROR",message:"Internal authentication error.",status:500})}}}async authorize(e,s,t){if(!e.isAuthenticated||!e.user)return this.createErrorResponse({error:"UNAUTHORIZED",message:"Authentication required.",status:401});let{ip:i,userAgent:r}=this.getClientInfo(s),n=s.nextUrl.pathname;try{if(this.config.allowedRoles&&!this.config.allowedRoles.includes(e.user.role))return await o.vF.warn("auth-middleware","Insufficient role",{userId:e.user.id,userRole:e.user.role,allowedRoles:this.config.allowedRoles,pathname:n}),this.createErrorResponse({error:"FORBIDDEN",message:"Insufficient privileges.",status:403});let s=t||this.config.requiredPermission;if(s){if("admin"===e.user.role&&"mock-session"===e.session.sessionId)return console.log(`[AUTH] Skipping permission check for mock admin user - ${s.resource}:${s.action}`),null;let t=await a.E.checkPermission({user:e.user,resource:s.resource,action:s.action,extraContext:{ip_address:i,user_agent:r}});if(!t.allowed)return await o.vF.warn("auth-middleware","Permission denied",{userId:e.user.id,resource:s.resource,action:s.action,reason:t.reason,pathname:n}),this.createErrorResponse({error:"FORBIDDEN",message:"Permission denied.",status:403,details:t.reason})}return await o.vF.debug("auth-middleware","Authorization successful",{userId:e.user.id,resource:s?.resource,action:s?.action,pathname:n}),null}catch(s){return await o.vF.error("auth-middleware","Authorization middleware error",s,{userId:e.user?.id,pathname:n}),this.createErrorResponse({error:"INTERNAL_ERROR",message:"Internal authorization error.",status:500})}}async process(e){let s=await this.authenticate(e);if(s.response)return s;let t=s.context;if(this.config.requireAuth&&t.isAuthenticated){let s=await this.authorize(t,e);if(s)return{response:s}}return{context:t}}}function l(e={}){return new c(e)}function d(e,s={}){return async t=>{let i=l(s),r=await i.process(t);return r.response?r.response:e(t,r.context)}}function u(e,s){return function(t={}){return{...t,requiredPermission:{resource:e,action:s}}}}async function m(e){let s=l({requireAuth:!1});return(await s.authenticate(e)).context||null}l()}};